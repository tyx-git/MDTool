# Markdown Reader 项目设计方案

## 1. 项目概述

### 1.1 项目简介
Markdown Reader 是一个基于 PyQt5 开发的 Windows 专用 Markdown 阅读器，提供直观的文件浏览和实时预览功能。该应用采用模块化设计，具有良好的可扩展性和维护性。

### 1.2 技术栈
- **GUI框架**: PyQt5 5.15.9
- **Web引擎**: PyQtWebEngine 5.15.6（用于Markdown渲染）
- **Markdown解析**: markdown 3.5
- **代码高亮**: Pygments 2.15
- **Windows集成**: pywin32 306
- **Python版本**: 3.8+

### 1.3 核心功能
- 目录树文件浏览（支持Markdown文件过滤）
- 实时Markdown预览（GitHub Flavored Markdown）
- 代码语法高亮
- 主题切换（浅色/深色/自动）
- Windows系统集成（任务栏进度、主题检测）
- 配置持久化（窗口位置、最近文件、标记文件等）
- 文件管理（重命名、删除、创建目录/文件）
- 文件标记（绿色/红色标记）

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────┐
│                  main.py                        │
│  (应用程序入口、日志、异常处理)                    │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│              MainWindow                          │
│  (主窗口、UI协调、事件处理)                        │
└───┬──────────┬──────────┬──────────┬───────────┘
    │          │          │          │
    ▼          ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌──────────┐
│Config  │ │Markdown│ │FileTree │ │Windows   │
│Manager │ │Renderer│ │         │ │Integration│
└────────┘ └────────┘ └────────┘ └──────────┘
```

### 2.2 模块划分

#### 2.2.1 主程序入口 (main.py)
**职责**:
- 应用程序初始化和配置
- 全局异常处理
- 日志系统设置
- 命令行参数处理
- 高DPI支持

**关键功能**:
- `setup_logging()`: 配置日志系统，日志文件保存在 `logs/` 目录
- `exception_hook()`: 全局异常捕获和记录
- `main()`: 主函数，创建应用和主窗口

#### 2.2.2 主窗口模块 (core/main_window.py)
**职责**:
- UI界面构建和布局管理
- 用户交互事件处理
- 各功能模块的协调
- 窗口状态管理

**核心组件**:
- `MainWindow`: 主窗口类
  - `_init_ui()`: 初始化用户界面
  - `_create_menu_bar()`: 创建菜单栏
  - `_create_status_bar()`: 创建状态栏
  - `_load_config()`: 加载配置
  - `_save_config()`: 保存配置
  - `_render_file()`: 渲染Markdown文件
  - `_show_welcome_page()`: 显示欢迎页面
  - `_ensure_web_view()`: 延迟初始化WebView

**UI布局**:
```
┌─────────────────────────────────────────┐
│           菜单栏 (MenuBar)               │
├──────────┬──────────────────────────────┤
│          │                              │
│ 文件树   │    Markdown预览区域           │
│ (FileTree)│    (QWebEngineView)          │
│          │                              │
│          │                              │
└──────────┴──────────────────────────────┘
│           状态栏 (StatusBar)              │
└─────────────────────────────────────────┘
```

**关键设计**:
- 使用 `QSplitter` 实现左右分栏布局
- 目录树宽度限制为总宽度的1/3
- WebView延迟初始化，提升启动性能
- 防抖定时器用于保存分割器位置

#### 2.2.3 配置管理模块 (core/config_manager.py)
**职责**:
- 应用程序配置的读取、保存和管理
- 配置文件的持久化存储

**配置项**:
- 窗口配置（位置、大小、分割器位置）
- 主题设置（light/dark/auto）
- 最近文件列表
- 最近目录列表
- 标记文件（字典：文件路径 -> 标记类型）
- 字体大小（正文、代码）

**存储位置**:
- Windows: `%APPDATA%\MarkdownReader\config\app.json`

**核心方法**:
- `get()` / `set()`: 获取/设置配置值（支持点号分隔的嵌套键）
- `get_window_config()`: 获取窗口配置
- `set_window_config()`: 设置窗口配置
- `get_splitter_position()` / `set_splitter_position()`: 分割器位置
- `get_file_mark()` / `set_file_mark()`: 文件标记管理
- `add_recent_file()` / `get_recent_files()`: 最近文件管理

#### 2.2.4 Markdown渲染器 (core/markdown_renderer.py)
**职责**:
- Markdown文本转换为HTML
- CSS样式应用
- 主题适配

**核心功能**:
- 支持GitHub Flavored Markdown扩展
- 代码语法高亮（Pygments）
- CSS缓存机制（提升性能）
- 自动主题检测

**支持的Markdown扩展**:
- `fenced_code`: 代码块
- `tables`: 表格
- `toc`: 目录
- `codehilite`: 代码高亮
- `nl2br`: 换行
- `sane_lists`: 列表
- `attr_list`: 属性列表
- `def_list`: 定义列表
- `footnotes`: 脚注
- `md_in_html`: HTML中的Markdown

**核心方法**:
- `render_file()`: 渲染Markdown文件
- `render_text()`: 渲染Markdown文本
- `_load_css()`: 加载CSS样式（带缓存）

#### 2.2.5 文件树模块 (core/file_tree.py)
**职责**:
- 文件系统浏览
- 文件选择和处理
- 右键菜单功能
- 文件系统监控

**核心组件**:
- `FileTree`: 文件树视图（继承自QTreeView）
- `FileTreeItemDelegate`: 自定义委托（用于显示标记文件的彩色文字）

**功能特性**:
- 只显示Markdown文件（*.md, *.markdown）
- 文件标记（绿色/红色）
- 右键菜单：
  - 标记（绿色）/ 标记（红色）
  - 取消标记
  - 重命名
  - 删除
  - 新建文件夹
  - 新建Markdown文件
- 文件系统监控（自动刷新）
- 展开状态记忆

**核心方法**:
- `set_root_path()`: 设置根路径
- `select_file()`: 选中文件
- `refresh()`: 刷新视图
- `_show_context_menu()`: 显示右键菜单
- `_rename_item()`: 重命名文件/目录
- `_delete_item()`: 删除文件/目录
- `_create_folder()`: 创建文件夹
- `_create_file()`: 创建文件

**信号**:
- `file_selected`: 文件被选中
- `folder_selected`: 文件夹被选中
- `file_marked_changed`: 文件标记改变

#### 2.2.6 Windows集成模块 (core/windows_integration.py)
**职责**:
- Windows系统功能集成
- 主题检测
- 任务栏功能

**核心功能**:
- 任务栏进度显示
- Windows主题检测（浅色/深色）
- 任务栏覆盖图标

**核心方法**:
- `is_dark_theme()`: 检测是否为深色主题（静态方法）
- `get_system_theme()`: 获取系统主题（静态方法）
- `set_progress()`: 设置任务栏进度
- `hide_progress()`: 隐藏任务栏进度

**设计说明**:
- 延迟初始化：在窗口显示后（`showEvent`）初始化，因为需要 `windowHandle()`
- 异常处理：Windows集成失败不影响程序运行

#### 2.2.7 资源路径模块 (core/resource_path.py)
**职责**:
- 资源文件路径解析
- 开发环境和打包环境的路径适配

**核心方法**:
- `get_resource_path()`: 获取资源文件的绝对路径
- `get_assets_dir()`: 获取assets目录路径
- `get_config_dir()`: 获取config目录路径

#### 2.2.8 设置对话框模块 (core/settings_dialog.py)
**职责**:
- 应用程序设置界面
- 用户配置修改

**设置项**:
- 主题选择（浅色/深色/自动）
- 正文字体大小
- 代码字体大小

## 3. 数据流设计

### 3.1 文件打开流程

```
用户操作
  │
  ├─ 菜单"打开文件"
  ├─ 工具栏按钮
  ├─ 文件树双击
  └─ 命令行参数
      │
      ▼
  MainWindow._open_file_path()
      │
      ├─ 验证文件存在性
      ├─ 添加到最近文件
      ├─ 更新文件树选中状态
      │
      ▼
  MainWindow._render_file()
      │
      ├─ 确保WebView已初始化
      ├─ 读取文件内容
      │
      ▼
  MarkdownRenderer.render_file()
      │
      ├─ 读取Markdown文件
      ├─ 转换为HTML
      ├─ 应用CSS样式
      │
      ▼
  QWebEngineView.setHtml()
      │
      ▼
  显示渲染结果
```

### 3.2 配置保存流程

```
用户操作（窗口关闭/分割器移动/设置修改）
  │
  ▼
  触发保存事件
  │
  ├─ closeEvent() → _save_config()
  ├─ splitterMoved → _save_splitter_position()
  └─ 设置对话框 → config.set() → config.save()
      │
      ▼
  ConfigManager.save()
      │
      ├─ 合并配置
      ├─ 序列化为JSON
      │
      ▼
  写入 %APPDATA%\MarkdownReader\config\app.json
```

### 3.3 主题切换流程

```
用户选择主题
  │
  ▼
  MainWindow._set_theme()
      │
      ├─ 更新配置
      ├─ 重新渲染当前文件
      └─ 更新欢迎页面
      │
      ▼
  MarkdownRenderer.render_file()
      │
      ├─ 检测实际主题（auto模式）
      ├─ 加载对应CSS
      │
      ▼
  应用新主题样式
```

## 4. UI/UX设计

### 4.1 界面布局

**主窗口布局**:
- 菜单栏：文件、视图、设置、帮助
- 主区域：左右分栏（QSplitter）
  - 左侧：文件树（最大宽度为总宽度的1/3）
  - 右侧：Markdown预览区域
- 状态栏：显示当前状态信息

### 4.2 交互设计

**文件树交互**:
- 单击：选中文件
- 双击：打开文件
- 右键：显示上下文菜单
- 标记文件：绿色/红色高亮显示

**分割器交互**:
- 可拖动调整左右区域大小
- 自动限制左侧最大宽度
- 位置自动保存

**主题切换**:
- 支持浅色、深色、自动三种模式
- 自动模式根据Windows系统主题切换
- 实时预览效果

### 4.3 视觉设计

**样式系统**:
- 使用QSS（Qt Style Sheets）定义界面样式
- CSS文件定义Markdown渲染样式
- 支持浅色/深色主题切换

**字体设置**:
- 可配置正文字体大小（默认16px）
- 可配置代码字体大小（默认14px）

## 5. 性能优化

### 5.1 启动性能优化
- **WebView延迟初始化**: 在首次需要渲染时才创建QWebEngineView，减少启动时间
- **CSS缓存**: MarkdownRenderer中实现CSS文件缓存，避免重复读取

### 5.2 运行时性能优化
- **防抖定时器**: 分割器位置保存使用防抖机制，避免频繁写入配置
- **文件系统监控**: 使用QFileSystemWatcher监控目录变化，按需刷新
- **展开状态记忆**: 文件树刷新时保持展开状态，减少用户操作

### 5.3 内存管理
- **占位符替换**: WebView初始化后替换占位符widget，及时释放资源
- **异常处理**: 完善的异常处理机制，防止内存泄漏

## 6. 错误处理与日志

### 6.1 异常处理策略
- **全局异常捕获**: `main.py`中设置全局异常钩子
- **模块级异常处理**: 各模块关键操作都有try-except保护
- **用户友好提示**: 异常时显示友好的错误对话框

### 6.2 日志系统
- **日志位置**: `logs/markdown_reader_YYYYMMDD.log`
- **日志级别**: DEBUG（开发环境）
- **日志格式**: 时间戳、模块名、级别、消息
- **日志输出**: 文件和控制台（如果可用）

### 6.3 关键操作日志记录
- 应用程序启动/退出
- 文件打开/渲染
- 配置加载/保存
- 异常和错误

## 7. 扩展性设计

### 7.1 模块化设计
- 各功能模块独立，低耦合
- 通过信号-槽机制通信
- 易于添加新功能

### 7.2 配置系统扩展
- 配置项通过点号分隔的键访问
- 支持嵌套配置结构
- 易于添加新配置项

### 7.3 主题系统扩展
- CSS文件独立，易于添加新主题
- 主题检测逻辑可扩展
- 支持自定义样式

## 8. 安全性考虑

### 8.1 文件操作安全
- 文件操作前验证路径存在性
- 删除操作前确认对话框
- 异常处理防止文件损坏

### 8.2 配置安全
- 配置文件使用JSON格式，易于验证
- 配置加载失败时使用默认配置
- 配置值范围验证（如字体大小）

### 8.3 资源路径安全
- 使用pathlib处理路径，避免路径注入
- 资源文件存在性检查

## 9. 测试策略

### 9.1 单元测试（建议）
- 配置管理器测试
- Markdown渲染器测试
- 文件树操作测试

### 9.2 集成测试（建议）
- 文件打开流程测试
- 配置保存/加载测试
- 主题切换测试

### 9.3 手动测试
- 不同Windows版本测试
- 不同分辨率测试
- 异常场景测试

## 10. 部署与分发

### 10.1 开发环境运行
```bash
# 安装依赖
pip install -r requirements.txt

# 运行程序
python main.py

# 或打开文件
python main.py path/to/file.md
```

### 10.2 打包分发（可选）
- 使用PyInstaller打包为exe
- 包含所有依赖和资源文件
- 单文件可执行程序

## 11. 未来改进方向

### 11.1 功能增强
- 支持更多Markdown扩展
- 支持导出为PDF/HTML
- 支持多标签页
- 支持搜索功能
- 支持书签功能

### 11.2 性能优化
- 大文件虚拟滚动
- 增量渲染
- 异步文件加载

### 11.3 用户体验
- 快捷键支持
- 拖拽打开文件
- 更多主题选择
- 自定义样式

## 12. 技术债务与已知问题

### 12.1 已知限制
- 仅支持Windows系统
- 大文件渲染可能较慢
- WebView初始化需要一定时间

### 12.2 待优化项
- 代码注释完善
- 类型提示补充
- 单元测试覆盖
- 文档完善

## 13. 总结

Markdown Reader 采用模块化、低耦合的设计，具有良好的可维护性和扩展性。通过延迟初始化、缓存机制等优化手段，提升了应用性能。完善的异常处理和日志系统，保证了应用的稳定性。该设计方案为项目的长期发展奠定了良好的基础。

